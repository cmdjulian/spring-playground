# syntax = docker/dockerfile:1.4.3

FROM ghcr.io/graalvm/native-image:muslib-ol9-java17-22.3.0 AS builder

ENV GRADLE_USER_HOME=".gradle-cache"
ENV NATIVE_IMAGE_CONFIG_FILE="/tmp/default.properties"
RUN echo "NativeImageArgs = --static --libc=musl" > "${NATIVE_IMAGE_CONFIG_FILE}"

WORKDIR /build
RUN microdnf install -y findutils
COPY --link . /build/
RUN --mount=type=cache,target=.gradle-cache ./gradlew nativeCompile --no-daemon


# compress application
FROM pratikimprowise/upx:3.96 AS shrinker

COPY --link --from=builder /build/build/native/nativeCompile/notes /build/notes
RUN [ "upx", "-9", "--best", "--ultra-brute", "/build/notes" ]


# final image
FROM gcr.io/distroless/static:nonroot

USER nonroot:nonroot
COPY --link --from=shrinker /build/notes /home/nonroot/notes
WORKDIR /home/nonroot

ENTRYPOINT ["/home/nonroot/notes"]
